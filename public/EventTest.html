<!DOCTYPE html>
<meta charset="UTF-8" />
<html>
  <head>
    <title>InterfaceKit Example</title>
    <script type="text/javascript" src="js/jquery-3.3.1.min.js"></script>
    <script src="js/sha256.min.js"></script>
    <script src="js/phidget22.min.js"></script>
    <script src="js/pubsub.js"></script>
  </head>
  <body>
    <script>
      var mySubscriber = function(msg, data) {
        console.log(msg, data);
      };

      // add the function to the list of subscribers for a particular topic
      // we're keeping the returned token, in order to be able to unsubscribe
      // from the topic later on
      var token = PubSub.subscribe("thumbstick", mySubscriber);
      PubSub.subscribe("thumbstick-x", mySubscriber)
      PubSub.subscribe("thumbstick-y", mySubscriber)
      var ThumbStick = function(x) {
        this.x = x;
        var that = this;
        this.conn = new phidget22.Connection(8989, "localhost");
        this.ch0 = new phidget22.VoltageRatioInput(); // axis 0
        this.ch1 = new phidget22.VoltageRatioInput(); // axis 1

        this.ThumbConnect = function() {
          var ch0 = that.ch0;
          ch0.setIsHubPortDevice(false);
          ch0.setHubPort(0);
          ch0.setChannel(0);
          ch0.onError = onError;
          ch0.onAttach = onAttach;
          var ch1 = that.ch1;
          ch1.setIsHubPortDevice(false);
          ch1.setHubPort(0);
          ch1.setChannel(1);
          ch1.onError = onError;
          ch1.onAttach = onAttach;
          that.conn
            .connect()
            .then(function() {
              console.log("Phidget Server Connected");
              PubSub.publish("thumbstick", "Connected");
              ch0
                .open(5000)
                .then(function(ch0) {
                  ch0.onVoltageRatioChange = ratioChangeAxis0;

                  console.log("channel open");
                  PubSub.publish("thumbstick", "x-axis open");
                  ch1
                    .open(5000)
                    .then(function(ch1) {
                      console.log("channel open");
                      ch1.onVoltageRatioChange = ratioChangeAxis1;

                      PubSub.publish("thumbstick", "y-axis open");
                    })
                    .catch(function(err) {
                      console.log("failed to open the channel:" + err);
                    });
                })
                .catch(function(err) {
                  console.log("failed to open the channel:" + err);
                });
            })
            .catch(function(err) {
              console.log("failed to connect to server:" + err);
            });
        };
        var onError = function(arg0, arg1) {
          console.log(`${arg0}: ${arg1}`);
        };
        var onAttach = function(ch) {
          console.log("axis attached");
        };
        var ratioChangeAxis0 = function(ratio) {
         // console.log(`Axis 0: ${ratio}`);
         PubSub.publish("thumbstick-x", ratio);
        };
        var ratioChangeAxis1 = function(ratio) {
         // console.log(`Axis 1: ${ratio}`);
         PubSub.publish("thumbstick-y", ratio);
        };
      };
      window.thumbStick = new ThumbStick();
      thumbStick.ThumbConnect();

    </script>
  </body>
</html>

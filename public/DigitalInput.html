<!DOCTYPE html>
<meta charset="UTF-8">
<html>
<title>DigitalInput Example</title>
<script type="text/javascript" src="js/jquery-3.3.1.min.js"></script>
<script src="/js/sha256.min.js"></script>
<script src="/js/phidget22.min.js"></script>
</html>
<script>

var phid;

$(document).ready(function() {
		var conn = new phidget22.Connection(8989, 'localhost');
		var ch = new phidget22.DigitalInput();

		ch.onError = onError;
		ch.onPropertyChange = propChange;
		ch.onAttach = onAttach;

		// If you want to open an input on a specific device, set the serial number:
		//ch.setDeviceSerialNumber(495379);

		// If you want to use the DigitalInput mode of a port on your VINT hub, use these:
		//ch.setIsHubPortDevice(true);
		//ch.setHubPort(0);

		ch.onDetach = function(ch) {
			$('#inputField').hide();
			$('#errorField').hide();
			$('#Attach').hide();
			$('#noAttach').show();
		}

		conn.connect().then(function() {
			console.log('connected');
			ch.open().then(function(ch) {
				console.log('channel open');
			}).catch(function(err) {
				console.log('failed to open the channel:' + err);
			});
		}).catch(function(err) {
			alert('failed to connect to server:' + err);
		});;
    });

    function onAttach(ch) {
        console.log(ch + ' attached');
        phid = ch;
        setLabel('attachLabel',ch.getDeviceClassName() + ' - ' + ch.getChannelClassName() + ' (Channel ' + ch.getChannel() + ')');
        setLabel('serialLabel',ch.getDeviceSerialNumber());
        setLabel('versionLabel',ch.getDeviceSKU() + ' ver.' + ch.getDeviceVersion());

        if(ch.getDeviceClass() == phidget22.DeviceClass.VINT)
            setLabel('hubPortLabel',ch.getHubPort());
        else
            setLabel('hubPortLabel','N/A');

        $('#inputField').show();
        $('#noAttach').hide();
        $('#Attach').show();

        phid.onStateChange = stateChange;
        phid.onError = onError;
        phid.onPropertyChange = propChange;

        if (phid.getState())
            $('#state').prop("checked",true);

        switch(phid.getDeviceID()){
            case phidget22.DeviceID.PN_1010_1013_1018_1019:
            case phidget22.DeviceID.PN_1202_1203_INTERFACEKIT:
            case phidget22.DeviceID.PN_1063_1067:
            case phidget22.DeviceID.PN_1060:
            case phidget22.DeviceID.PN_1065:
            case phidget22.DeviceID.PN_1047:
            case phidget22.DeviceID.PN_1057:
            case phidget22.DeviceID.DIGITAL_INPUT_PORT:
            case phidget22.DeviceID.PN_DAQ1300:
            case phidget22.DeviceID.PN_DAQ1301:
            case phidget22.DeviceID.PN_DAQ1200:
                $('#supplyLabel').hide();
                $('#supplyCombo').hide();
                $('#modeLabel').hide();
                $('#modeCombo').hide();
                break;
            case phidget22.DeviceID.PN_DAQ1400:
                $('#modeCombo').val(phid.getInputMode());
                $('#supplyCombo').val(phid.getPowerSupply());
                break;
            default:
                break;
        }

    }

function propChange(prop) {

	if (prop === 'InputMode')
		$('#modeCombo').val(this.getInputMode());

	if (prop === 'PowerSupply')
		$('#supplyCombo').val(this.getPowerSupply());
}

function stateChange(state) {

	if (state)
		$('#state').prop("checked",true);
	else
		$('#state').prop("checked",false);
}

function supplyChange() {

	phid.setPowerSupply($('#supplyCombo').val());
}

function modeChange() {

	phid.setInputMode($('#modeCombo').val());
}

function onError(arg0, arg1) {

    var d = new Date();
    $('#errorTable').append('<tr><td> ' + d.getHours() + ':' + d.getMinutes() + ':' + d.getSeconds() + '.' + d.getMilliseconds() + '</td><td> 0x' + arg0.toString(16) + '</td><td>' + arg1 + '</td>');
    $("#errorField").show();
}

function setLabel(name, value) {

    $('#' + name).text(value);
}

</script>
<body>
    <fieldset id="noAttach">
            <label>No Phidget Attached</label>
    </fieldset>

    <fieldset id="Attach" hidden>
        <table>
            <tr>
                <td><label>Attached:</label></td><td colspan='2'><label id='attachLabel'></label></td>
            </tr>
            <tr>
                <td><label>Product:</label></td><td><label id='versionLabel'></label></td>
            </tr>
            <tr>
                <td><label>Serial Number:</label></td><td><label id='serialLabel'></label></td>
            </tr>
            <tr>
                <td><label>Hub Port:</label></td><td><label id='hubPortLabel'></label></td>
            </tr>
        </table>
    </fieldset>
	<fieldset id="inputField" hidden>
		<legend><label >Data</label></legend>
		<table>
			<tr>
				<td><label>State</label></td>
                <td><label id='modeLabel'>Mode</label></td>
			</tr>
			<tr>
				<td style="text-align:center"><input type="checkbox" onclick="return false;" readonly id='state' value="0"></td>
                <td> <select  onChange='modeChange()' id='modeCombo'>
                <option value="1">NPN</option>
                <option value="2">PNP</option>
                </select></td>
			</tr>
            <tr>
            	<td><label  id='supplyLabel'>Power Supply:</label></td>
                <td><select  onChange='supplyChange()' id='supplyCombo'>
                <option value="1">Off</option>
                <option value="2">12V</option>
                <option value="3">24V</option>
                </select></td>
            </tr>
		</table>
	</fieldset>
    <fieldset id="errorField" hidden>
        <legend>Errors</legend>
        <table id="errorTable">
            <col width="100"><col width="100"><col width="400">
            <thead><tr>
                <th align='left'>Time</th>
                <th align='center'>Error #</th>
                <th align='center'>Desc</th>
                <th><input type='submit' size='9' onclick="$('#errorTable tbody').remove();" value='Clear'></th>
            </tr></thead>
        </table>
    </fieldset>
</body>
</html>
